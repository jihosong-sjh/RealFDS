name: CI - Build and Test

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop, 'feature/**' ]

jobs:
  # Java/Gradle 서비스 빌드 & 테스트
  build-java-services:
    name: Build ${{ matrix.name }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: alert-service
            path: alert-service
          - name: websocket-gateway
            path: websocket-gateway
          - name: fraud-detector
            path: fraud-detector
          - name: alert-dashboard-backend
            path: alert-dashboard/backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        working-directory: ${{ matrix.path }}
        run: chmod +x gradlew

      - name: Build with Gradle
        working-directory: ${{ matrix.path }}
        run: ./gradlew build --no-daemon -x test

      - name: Run tests
        working-directory: ${{ matrix.path }}
        run: ./gradlew test --no-daemon

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports-${{ matrix.name }}
          path: ${{ matrix.path }}/build/reports/tests/test/
          retention-days: 7

  # Python 서비스 빌드 & 테스트
  build-python-service:
    name: Build transaction-generator
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        working-directory: transaction-generator
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Lint with flake8
        working-directory: transaction-generator
        run: |
          pip install flake8
          # stop the build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # exit-zero treats all errors as warnings
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        continue-on-error: true

      - name: Run tests (if exists)
        working-directory: transaction-generator
        run: |
          if [ -d "tests" ] || [ -f "test_*.py" ]; then
            pip install pytest pytest-cov
            pytest --cov=. --cov-report=xml
          else
            echo "No tests found, skipping..."
          fi
        continue-on-error: true

  # React 프론트엔드 빌드 & 테스트
  build-frontend:
    name: Build frontend-dashboard
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend-dashboard/package-lock.json

      - name: Install dependencies
        working-directory: frontend-dashboard
        run: npm ci

      - name: Lint code
        working-directory: frontend-dashboard
        run: |
          if grep -q "\"lint\"" package.json; then
            npm run lint
          else
            echo "No lint script found, skipping..."
          fi
        continue-on-error: true

      - name: Run tests
        working-directory: frontend-dashboard
        run: npm test -- --run
        env:
          CI: true

      - name: Build production bundle
        working-directory: frontend-dashboard
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend-dashboard/dist/
          retention-days: 7

  # 모든 빌드가 성공했는지 확인
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs:
      - build-java-services
      - build-python-service
      - build-frontend

    steps:
      - name: All builds passed
        run: echo "✅ All builds and tests passed successfully!"
