# Alert Service - Spring Boot Application Configuration
# 알림 서비스 설정 파일
#
# 이 파일은 alert-service의 핵심 설정을 정의합니다.
# 모든 설정은 환경 변수로 오버라이드 가능하도록 구성되어 있습니다.

# 서버 설정
server:
  port: ${SERVER_PORT:8081}  # 서버 포트 (기본값: 8081, 환경 변수: SERVER_PORT)

# Spring 애플리케이션 설정
spring:
  application:
    name: alert-service  # 애플리케이션 이름

  # R2DBC 설정 (Reactive 데이터베이스 연결)
  r2dbc:
    url: ${SPRING_R2DBC_URL:r2dbc:postgresql://localhost:5432/realfds}
    username: ${SPRING_R2DBC_USERNAME:postgres}
    password: ${SPRING_R2DBC_PASSWORD:postgres}
    pool:
      # 커넥션 풀 설정
      initial-size: ${R2DBC_POOL_INITIAL_SIZE:10}  # 초기 커넥션 수
      max-size: ${R2DBC_POOL_MAX_SIZE:30}  # 최대 커넥션 수
      max-idle-time: ${R2DBC_POOL_MAX_IDLE_TIME:30m}  # 최대 유휴 시간
      validation-query: SELECT 1  # 커넥션 검증 쿼리

  # Flyway 설정 (데이터베이스 마이그레이션)
  flyway:
    # Flyway는 JDBC를 사용하므로 별도의 JDBC URL 필요
    url: ${SPRING_FLYWAY_URL:jdbc:postgresql://localhost:5432/realfds}
    user: ${SPRING_FLYWAY_USER:postgres}
    password: ${SPRING_FLYWAY_PASSWORD:postgres}
    # 마이그레이션 스크립트 위치
    locations: classpath:db/migration
    # 마이그레이션 활성화
    enabled: ${SPRING_FLYWAY_ENABLED:true}
    # 기본 스키마
    default-schema: public
    # 마이그레이션 테이블 이름
    table: flyway_schema_history
    # 베이스라인 설정
    baseline-on-migrate: ${SPRING_FLYWAY_BASELINE_ON_MIGRATE:true}
    baseline-version: 1.0
    # 마이그레이션 검증
    validate-on-migrate: ${SPRING_FLYWAY_VALIDATE_ON_MIGRATE:true}
    # 스키마 자동 생성
    create-schemas: true

  # Kafka 설정
  kafka:
    # Kafka 브로커 주소
    bootstrap-servers: ${KAFKA_BOOTSTRAP_SERVERS:localhost:9092}

    # Consumer 설정 (transaction-alerts 토픽에서 알림 메시지 수신)
    consumer:
      # Consumer 그룹 ID - 같은 그룹의 컨슈머들은 메시지를 분산 처리
      group-id: ${KAFKA_CONSUMER_GROUP_ID:alert-service-group}

      # 자동 오프셋 커밋 설정 (true: 자동, false: 수동)
      enable-auto-commit: ${KAFKA_CONSUMER_ENABLE_AUTO_COMMIT:true}

      # 오프셋이 없을 때 시작 위치 (earliest: 처음부터, latest: 최신부터)
      auto-offset-reset: ${KAFKA_CONSUMER_AUTO_OFFSET_RESET:earliest}

      # Key Deserializer (문자열)
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer

      # Value Deserializer (JSON → Java 객체)
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer

      # Consumer 추가 속성
      properties:
        # JSON 역직렬화를 위한 신뢰할 수 있는 패키지 목록
        # 보안상 특정 패키지만 역직렬화를 허용합니다
        spring.json.trusted.packages: com.realfds.alert.model

        # 한 번에 가져올 최대 레코드 수
        max.poll.records: ${KAFKA_CONSUMER_MAX_POLL_RECORDS:500}

        # Poll 타임아웃 (밀리초)
        max.poll.interval.ms: ${KAFKA_CONSUMER_MAX_POLL_INTERVAL_MS:300000}

        # 세션 타임아웃 (밀리초)
        session.timeout.ms: ${KAFKA_CONSUMER_SESSION_TIMEOUT_MS:30000}

# 로깅 설정
logging:
  level:
    root: ${LOG_LEVEL_ROOT:INFO}  # 전체 로그 레벨 (기본값: INFO)
    com.realfds.alert: ${LOG_LEVEL_APP:INFO}  # 애플리케이션 로그 레벨
    org.springframework.kafka: ${LOG_LEVEL_KAFKA:INFO}  # Spring Kafka 로그 레벨
    org.apache.kafka: ${LOG_LEVEL_KAFKA_CLIENT:WARN}  # Kafka 클라이언트 로그 레벨
    org.springframework.r2dbc: ${LOG_LEVEL_R2DBC:INFO}  # R2DBC 로그 레벨
    org.flywaydb: ${LOG_LEVEL_FLYWAY:INFO}  # Flyway 로그 레벨

# Management 엔드포인트 설정 (Health Check 등)
management:
  endpoints:
    web:
      exposure:
        include: health  # health 엔드포인트만 노출
  endpoint:
    health:
      show-details: ${MANAGEMENT_HEALTH_SHOW_DETAILS:always}  # 상세 정보 표시 여부
